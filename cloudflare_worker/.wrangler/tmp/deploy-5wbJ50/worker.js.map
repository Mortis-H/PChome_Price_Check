{
  "version": 3,
  "sources": ["../../../src/worker.js"],
  "sourceRoot": "D:\\Code\\pchome_\u50F9\u683C\u7D00\u9304\u5668\\cloudflare_worker\\.wrangler\\tmp\\deploy-5wbJ50",
  "sourcesContent": ["export default {\n  async fetch(request, env) {\n    const url = new URL(request.url);\n    const path = url.pathname;\n    const cache = caches.default;\n    const cacheTtlSeconds = 1800;\n\n    if (request.method === \"OPTIONS\") {\n      return withCors(new Response(\"\", { status: 204 }));\n    }\n\n    if (path === \"/health\") {\n      return withCors(json({ ok: true }));\n    }\n\n    if (path === \"/stats\") {\n      const row = await env.DB.prepare(\n        \"SELECT COUNT(*) AS c, MAX(updated_at) AS last_updated FROM lowest_prices\"\n      ).first();\n      return withCors(json({ ok: true, count: row?.c ?? 0, last_updated: row?.last_updated ?? null }));\n    }\n\n    if (path === \"/lowest\" && (request.method === \"GET\" || request.method === \"POST\")) {\n      if (request.method === \"GET\") {\n        const cached = await cache.match(request);\n        if (cached) {\n          const hitResponse = withCors(cached);\n          hitResponse.headers.set(\"X-Cache\", \"HIT\");\n          return hitResponse;\n        }\n      }\n      const prodId = await getProdId(request, url);\n      if (!prodId) {\n        return withCors(json({ ok: false, error: \"Missing prodId\" }, 400));\n      }\n      const row = await env.DB.prepare(\n        \"SELECT min_price, updated_at FROM lowest_prices WHERE prod_id = ?\"\n      ).bind(prodId).first();\n      const payload = row\n        ? { prodId, minPrice: row.min_price, updatedAt: row.updated_at }\n        : { prodId, minPrice: null, updatedAt: null };\n      const response = withCors(json(payload));\n      response.headers.set(\"X-Cache\", request.method === \"GET\" ? \"MISS\" : \"BYPASS\");\n      if (payload.minPrice == null) {\n        response.headers.set(\"Cache-Control\", \"no-store\");\n      } else {\n        response.headers.set(\"Cache-Control\", `public, max-age=${cacheTtlSeconds}`);\n        if (request.method === \"GET\") {\n          await cache.put(request, response.clone());\n        }\n      }\n      return response;\n    }\n\n    if (path === \"/ingest\" && request.method === \"POST\") {\n      const payload = await request.json().catch(() => null);\n      if (!payload || !Array.isArray(payload.items)) {\n        return withCors(json({ ok: false, error: \"Invalid payload\" }, 400));\n      }\n      if (payload.items.length > 200) {\n        return withCors(json({ ok: false, error: \"Too many items\" }, 400));\n      }\n      const now = new Date().toISOString();\n      let stored = 0;\n\n      const stmt = env.DB.prepare(\n        \"INSERT INTO lowest_prices (prod_id, min_price, updated_at) VALUES (?, ?, ?) \" +\n          \"ON CONFLICT(prod_id) DO UPDATE SET \" +\n          \"min_price = CASE WHEN excluded.min_price < lowest_prices.min_price \" +\n          \"THEN excluded.min_price ELSE lowest_prices.min_price END, \" +\n          \"updated_at = CASE WHEN excluded.min_price < lowest_prices.min_price \" +\n          \"THEN excluded.updated_at ELSE lowest_prices.updated_at END\"\n      );\n\n      for (const item of payload.items) {\n        const prodId = typeof item.prodId === \"string\" ? item.prodId.trim() : \"\";\n        const price = Number(item.price);\n        if (!prodId || !Number.isFinite(price) || price < 0) {\n          continue;\n        }\n        const res = await stmt.bind(prodId, price, now).run();\n        if (res.success) {\n          stored += 1;\n          const cacheKey = new Request(\n            new URL(`/lowest?prodId=${encodeURIComponent(prodId)}`, url.origin),\n            { method: \"GET\" }\n          );\n          await cache.delete(cacheKey);\n        }\n      }\n      return withCors(json({ ok: true, count: payload.items.length, stored }));\n    }\n\n    return withCors(json({ ok: false, error: \"Not found\" }, 404));\n  },\n};\n\nasync function getProdId(request, url) {\n  if (request.method === \"GET\") {\n    return (url.searchParams.get(\"prodId\") || \"\").trim();\n  }\n  const payload = await request.json().catch(() => null);\n  if (payload && typeof payload.prodId === \"string\") {\n    return payload.prodId.trim();\n  }\n  return \"\";\n}\n\nfunction json(body, status = 200) {\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: { \"Content-Type\": \"application/json; charset=utf-8\" },\n  });\n}\n\nfunction withCors(response) {\n  const headers = new Headers(response.headers);\n  headers.set(\"Access-Control-Allow-Origin\", \"*\");\n  headers.set(\"Access-Control-Allow-Methods\", \"GET,POST,OPTIONS\");\n  headers.set(\"Access-Control-Allow-Headers\", \"Content-Type\");\n  return new Response(response.body, { status: response.status, headers });\n}\n"],
  "mappings": "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",
  "names": []
}
