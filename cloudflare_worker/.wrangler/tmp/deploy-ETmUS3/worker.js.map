{
  "version": 3,
  "sources": ["../../../src/worker.js"],
  "sourceRoot": "D:\\Code\\pchome_\u50F9\u683C\u7D00\u9304\u5668\\cloudflare_worker\\.wrangler\\tmp\\deploy-ETmUS3",
  "sourcesContent": ["export default {\n  async fetch(request, env) {\n    const url = new URL(request.url);\n    const path = url.pathname;\n    const cache = caches.default;\n    const cacheTtlSeconds = 600;\n\n    if (request.method === \"OPTIONS\") {\n      return withCors(new Response(\"\", { status: 204 }));\n    }\n\n    if (path === \"/health\") {\n      return withCors(json({ ok: true }));\n    }\n\n    if (path === \"/stats\") {\n      const row = await env.DB.prepare(\n        \"SELECT COUNT(*) AS c, MAX(updated_at) AS last_updated FROM lowest_prices\"\n      ).first();\n      return withCors(json({ ok: true, count: row?.c ?? 0, last_updated: row?.last_updated ?? null }));\n    }\n\n    if (path === \"/lowest\" && (request.method === \"GET\" || request.method === \"POST\")) {\n      if (request.method === \"GET\") {\n        const cached = await cache.match(request);\n        if (cached) {\n          return withCors(cached);\n        }\n      }\n      const prodId = await getProdId(request, url);\n      if (!prodId) {\n        return withCors(json({ ok: false, error: \"Missing prodId\" }, 400));\n      }\n      const row = await env.DB.prepare(\n        \"SELECT min_price, updated_at FROM lowest_prices WHERE prod_id = ?\"\n      ).bind(prodId).first();\n      const payload = row\n        ? { prodId, minPrice: row.min_price, updatedAt: row.updated_at }\n        : { prodId, minPrice: null, updatedAt: null };\n      const response = withCors(json(payload));\n      const ttl = payload.minPrice == null ? 0 : cacheTtlSeconds;\n      response.headers.set(\"Cache-Control\", `public, max-age=${ttl}`);\n      if (request.method === \"GET\") {\n        if (ttl > 0) {\n          await cache.put(request, response.clone());\n        }\n      }\n      return response;\n    }\n\n    if (path === \"/lowest/batch\" && request.method === \"POST\") {\n      const payload = await request.json().catch(() => null);\n      if (!payload || !Array.isArray(payload.prodIds)) {\n        return withCors(json({ ok: false, error: \"Invalid payload\" }, 400));\n      }\n      const prodIds = payload.prodIds\n        .filter((value) => typeof value === \"string\")\n        .map((value) => value.trim())\n        .filter((value) => value.length > 0);\n      if (prodIds.length === 0) {\n        return withCors(json({ ok: false, error: \"No prodIds\" }, 400));\n      }\n      if (prodIds.length > 200) {\n        return withCors(json({ ok: false, error: \"Too many prodIds\" }, 400));\n      }\n\n      const unique = Array.from(new Set(prodIds));\n      const results = new Map();\n      const missIds = [];\n\n      for (const prodId of unique) {\n        const cacheKey = new Request(\n          new URL(`/lowest?prodId=${encodeURIComponent(prodId)}`, url.origin),\n          { method: \"GET\" }\n        );\n        const cached = await cache.match(cacheKey);\n        if (cached) {\n          const data = await cached.clone().json().catch(() => null);\n          if (data && typeof data.prodId === \"string\") {\n            results.set(prodId, {\n              prodId,\n              minPrice: data.minPrice ?? null,\n              updatedAt: data.updatedAt ?? null,\n            });\n            continue;\n          }\n        }\n        missIds.push(prodId);\n      }\n\n      const rowsById = new Map();\n      const chunkSize = 100;\n      for (let i = 0; i < missIds.length; i += chunkSize) {\n        const chunk = missIds.slice(i, i + chunkSize);\n        const placeholders = chunk.map(() => \"?\").join(\", \");\n        const stmt = env.DB.prepare(\n          `SELECT prod_id, min_price, updated_at FROM lowest_prices WHERE prod_id IN (${placeholders})`\n        ).bind(...chunk);\n        const rows = await stmt.all();\n        for (const row of rows.results || []) {\n          rowsById.set(row.prod_id, row);\n        }\n      }\n\n      for (const prodId of missIds) {\n        const row = rowsById.get(prodId);\n        const item = row\n          ? { prodId, minPrice: row.min_price, updatedAt: row.updated_at }\n          : { prodId, minPrice: null, updatedAt: null };\n        results.set(prodId, item);\n        const cacheKey = new Request(\n          new URL(`/lowest?prodId=${encodeURIComponent(prodId)}`, url.origin),\n          { method: \"GET\" }\n        );\n        const response = withCors(json(item));\n        const ttl = item.minPrice == null ? 0 : cacheTtlSeconds;\n        response.headers.set(\"Cache-Control\", `public, max-age=${ttl}`);\n        if (ttl > 0) {\n          await cache.put(cacheKey, response);\n        }\n      }\n\n      const items = prodIds.map((prodId) => results.get(prodId) || { prodId, minPrice: null, updatedAt: null });\n      return withCors(json({ ok: true, items }));\n    }\n\n    if (path === \"/ingest\" && request.method === \"POST\") {\n      const payload = await request.json().catch(() => null);\n      if (!payload || !Array.isArray(payload.items)) {\n        return withCors(json({ ok: false, error: \"Invalid payload\" }, 400));\n      }\n      if (payload.items.length > 200) {\n        return withCors(json({ ok: false, error: \"Too many items\" }, 400));\n      }\n      const now = new Date().toISOString();\n      let stored = 0;\n\n      const stmt = env.DB.prepare(\n        \"INSERT INTO lowest_prices (prod_id, min_price, updated_at) VALUES (?, ?, ?) \" +\n          \"ON CONFLICT(prod_id) DO UPDATE SET \" +\n          \"min_price = CASE WHEN excluded.min_price < lowest_prices.min_price \" +\n          \"THEN excluded.min_price ELSE lowest_prices.min_price END, \" +\n          \"updated_at = CASE WHEN excluded.min_price < lowest_prices.min_price \" +\n          \"THEN excluded.updated_at ELSE lowest_prices.updated_at END\"\n      );\n\n      for (const item of payload.items) {\n        const prodId = typeof item.prodId === \"string\" ? item.prodId.trim() : \"\";\n        const price = Number(item.price);\n        if (!prodId || !Number.isFinite(price) || price < 0) {\n          continue;\n        }\n        const res = await stmt.bind(prodId, price, now).run();\n        if (res.success) {\n          stored += 1;\n        }\n      }\n      return withCors(json({ ok: true, count: payload.items.length, stored }));\n    }\n\n    return withCors(json({ ok: false, error: \"Not found\" }, 404));\n  },\n};\n\nasync function getProdId(request, url) {\n  if (request.method === \"GET\") {\n    return (url.searchParams.get(\"prodId\") || \"\").trim();\n  }\n  const payload = await request.json().catch(() => null);\n  if (payload && typeof payload.prodId === \"string\") {\n    return payload.prodId.trim();\n  }\n  return \"\";\n}\n\nfunction json(body, status = 200) {\n  return new Response(JSON.stringify(body), {\n    status,\n    headers: { \"Content-Type\": \"application/json; charset=utf-8\" },\n  });\n}\n\nfunction withCors(response) {\n  const headers = new Headers(response.headers);\n  headers.set(\"Access-Control-Allow-Origin\", \"*\");\n  headers.set(\"Access-Control-Allow-Methods\", \"GET,POST,OPTIONS\");\n  headers.set(\"Access-Control-Allow-Headers\", \"Content-Type\");\n  return new Response(response.body, { status: response.status, headers });\n}\n"],
  "mappings": "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",
  "names": []
}
